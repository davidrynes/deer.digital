<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawl ČR 2025</title>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: transparent;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: flex-end;
        }

        .dashboard-container {
            width: 100%;
            height: 165px;
            background: transparent;
            display: flex;
            flex-direction: column;
            position: fixed;
            bottom: 0;
            left: 0;
        }

        /* Header pro ČR crawl */
        .cr-header {
            height: 50px;
            background: #e92929;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 12px 20px;
        }

        .cr-header-content {
            font-size: 24px;
            font-weight: 600;
            color: #fafafa;
        }

        .cr-header-separator {
            margin: 0 12px;
            color: #fafafa;
            font-weight: 400;
        }

        .cr-header-stats {
            font-size: 18px;
            font-weight: 500;
            color: #fafafa;
        }

        .cr-header-debug {
            margin-left: auto;
            font-size: 14px;
            color: #ffc0c0;
        }

        /* Kontejner pro parties ČR crawl */
        .cr-parties-container {
            display: flex;
            height: 115px;
            align-items: center;
            position: relative;
            background: #f8f9fa;
            white-space: nowrap;
            transform: translateX(100%);
        }

        @keyframes cr-scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .cr-parties-container.animate {
            animation: cr-scroll-left 60s linear infinite;
        }

        /* Animace pro refresh dat po dokončení */
        @keyframes cr-scroll-left-with-refresh {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .cr-parties-container.refresh {
            animation: cr-scroll-left-with-refresh 60s linear;
        }

        .cr-parties-container.updating {
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .cr-party-block {
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px 16px;
            margin: 0;
            width: 220px;
            position: relative;
            background: white;
            border-left: 4px solid;
            border-right: 1px solid #e9ecef;
            text-align: left;
            height: 115px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .cr-party-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .cr-party-name {
            font-size: 26px;
            font-weight: 700;
            color: #212529;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            line-height: 1.1;
            flex: 1;
            margin-right: 8px;
            word-wrap: break-word;
        }

        .cr-party-mandates {
            font-size: 26px;
            font-weight: 700;
            color: #212529;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cr-mandate-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .cr-party-percent {
            font-size: 42px;
            font-weight: 800;
            color: #212529;
            line-height: 1;
            text-align: right;
            align-self: flex-end;
        }

        .cr-divider {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 50px;
            flex-shrink: 0; /* Důležité - zabraňuje smrštění divideru */
        }

        .cr-divider-dot {
            width: 4px;
            height: 4px;
            background: #ced4da;
            border-radius: 50%;
            margin: 0 4px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 18px;
            color: #6c757d;
            font-weight: 500;
        }

        .updating {
            opacity: 0.7;
            transition: opacity 0.15s ease-in-out;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            border-radius: 5px;
            z-index: 9999;
        }

        .debug-panel.hidden {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .dashboard-container {
                height: 125px;
            }

            .cr-header {
                height: 35px;
                padding: 8px 15px;
            }

            .cr-header-content {
                font-size: 18px;
            }

            .cr-header-stats {
                font-size: 14px;
            }

            .cr-header-separator {
                margin: 0 8px;
            }

            .cr-parties-container {
                height: 90px;
            }

        .cr-party-block {
            width: 220px;
            height: 90px;
            padding: 6px 10px 4px 10px;
            border-left-width: 2px;
        }

            .cr-party-name {
                font-size: 12px;
                max-width: 80px;
            }

            .cr-party-mandates {
                font-size: 18px;
            }

            .cr-party-percent {
                font-size: 16px;
            }

            .cr-divider {
                width: 40px;
            }

            .loading {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="cr-crawl-container">
            <div class="cr-header">
                <div class="cr-header-content" id="crHeaderContent">Česká republika</div>
                <div class="cr-header-separator">|</div>
                <div class="cr-header-stats" id="crHeaderStats">sečteno: 0,00%, účast: 0,00%</div>
                <div class="cr-header-debug" id="crHeaderDebug"></div>
            </div>
            <div class="cr-parties-container" id="crPartiesContainer">
                <div class="loading">Načítám celkové výsledky ČR 2025...</div>
            </div>
        </div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel hidden" id="debugPanel">
        <div>Debug Info:</div>
        <div id="debugContent"></div>
    </div>

    <script>
        let crData = null;
        let isUpdating = false;
        
        // Debug mode - zapnout pro lokální vývoj nebo přidáním ?debug=true do URL
        const urlParams = new URLSearchParams(window.location.search);
        const isDebugMode = urlParams.get('debug') === 'true' || 
                          window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1';
        
        const debugLog = function(...args) {
            if (isDebugMode) {
                console.log(...args);
                updateDebugPanel(...args);
            }
        };

        function updateDebugPanel(...args) {
            if (!isDebugMode) return;
            
            const panel = document.getElementById('debugPanel');
            const content = document.getElementById('debugContent');
            
            if (panel) {
                panel.classList.remove('hidden');
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
                ).join(' ');
                
                content.innerHTML = `${new Date().toLocaleTimeString()}: ${message}<br>${content.innerHTML}`.substring(0, 1000);
            }
        }

        // Oprava kódování z API (špatné UTF-8)
        function fixEncoding(text) {
            if (!text) return '';
            
            // Mapování nejčastějších chyb v kódování
            const replacements = {
                'Ă­': 'í', 'ĂĄ': 'á', 'ĂŠ': 'é', 'Ă˝': 'ý',
                'Ĺž': 'ž', 'Ĺ ': 'š', 'Ä': 'č', 'Ĺ': 'ř',
                'Ä': 'ď', 'Ĺ¥': 'ť', 'Ĺ': 'ň', 'Ăş': 'ú', 'Ĺ¯': 'ů',
                'Ă': 'Í', 'Ă': 'Á', 'Ă': 'É', 'Ă': 'Ý',
                'Ĺ˝': 'Ž', 'Ĺ': 'Š', 'Ä': 'Č', 'Ĺ': 'Ř',
                'Ä': 'Ď', 'Ĺ¤': 'Ť', 'Ĺ': 'Ň', 'Ă': 'Ú', 'Ĺ®': 'Ů',
                'Ä': 'ě', 'Ä': 'Ě', 'Ăł': 'ó', 'Ă': 'Ó',
                'â': '—', 'âŚ': '…', 'â': '"', 'â': '"'
            };
            
            let fixed = text;
            for (const [wrong, correct] of Object.entries(replacements)) {
                fixed = fixed.replace(new RegExp(wrong, 'g'), correct);
            }
            
            return fixed;
        }

        // Escapování HTML pro bezpečné vložení názvů stran
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            // Nejdřív opravit kódování, pak escapovat
            const fixed = fixEncoding(unsafe);
            return fixed
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Formátování čísel pro českou lokalizaci
        function formatNumber(num) {
            if (num === null || num === undefined) return "0";
            return new Intl.NumberFormat('cs-CZ').format(num);
        }

        // Formátování procent
        function formatPercent(num) {
            if (num === null || num === undefined || isNaN(num)) return "0.0";
            return parseFloat(num).toFixed(1);
        }

        // Formátování pro "před volbami" stav
        function formatPercentForDisplay(num) {
            if (num === null || num === undefined || isNaN(num)) return "0.0";
            return parseFloat(num).toFixed(1);
        }

        async function loadCrData() {
            debugLog('🔄 Začínám načítání dat za celou ČR...');
            
            try {
                let response;
                let dataSource = 'unknown';
                
                // Pokus 1: Přímé načtení z API
                try {
                    const apiUrl = 'https://api.elections.seznam.cz/parliament/2025/results/cr';
                    response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    dataSource = 'direct-api';
                    debugLog('✅ Přímé načtení z API úspěšné');
                } catch (error) {
                    debugLog('❌ Přímé načtení selhalo:', error.message);
                    
                    // Pokus 2: CORS proxy
                    const corsProxies = [
                        'https://cors-anywhere.herokuapp.com/',
                        'https://api.allorigins.win/raw?url=',
                        'https://thingproxy.freeboard.io/fetch/'
                    ];
                    
                    let proxySuccess = false;
                    for (const proxy of corsProxies) {
                        try {
                            const proxyUrl = proxy + encodeURIComponent('https://api.elections.seznam.cz/parliament/2025/results/cr');
                            response = await fetch(proxyUrl);
                            if (response.ok) {
                                dataSource = `proxy-${proxy}`;
                                debugLog(`✅ CORS proxy úspěšné: ${proxy}`);
                                proxySuccess = true;
                                break;
                            }
                        } catch (proxyError) {
                            debugLog(`❌ CORS proxy selhalo: ${proxy}`, proxyError.message);
                            continue;
                        }
                    }
                    
                    if (!proxySuccess) {
                        throw new Error('Všechny pokusy o načtení dat selhaly');
                    }
                }
                
                const data = await response.json();
                debugLog('📊 Raw data struktura:', Object.keys(data));
                debugLog(`📊 Data source: ${dataSource}`);
                
                // Detekce problémů s kódováním
                const sampleText = JSON.stringify(data).substring(0, 500);
                const needsFixing = sampleText.includes('Ă') || sampleText.includes('Ĺ') || sampleText.includes('Ä');
                if (needsFixing) {
                    debugLog('⚠️ Detekováno poškozené UTF-8 kódování, aplikuji opravu...');
                } else {
                    debugLog('✅ Kódování v pořádku, data jsou čitelná');
                }
                
                // Různé možné struktury API
                let allParties = [];
                
                // Pokus 1: _items (API 2025)
                
                // Pokus 1: _items (API 2025)
                if (data._items && Array.isArray(data._items)) {
                    allParties = data._items;
                    debugLog(`📊 Nalezeno ${allParties.length} stran v _items`);
                }
                // Pokus 2: parties (starší API)
                else if (data.parties && Array.isArray(data.parties)) {
                    allParties = data.parties;
                    debugLog(`📊 Nalezeno ${allParties.length} stran v parties`);
                }
                // Pokus 3: results
                else if (data.results && Array.isArray(data.results)) {
                    allParties = data.results;
                    debugLog(`📊 Nalezeno ${allParties.length} stran v results`);
                }
                // Pokus 4: data je přímo array
                else if (Array.isArray(data)) {
                    allParties = data;
                    debugLog(`📊 Data jsou přímo array s ${allParties.length} stranami`);
                }
                
                debugLog(`📊 Celkem nalezeno ${allParties.length} položek před zpracováním`);
                
                // Vypsat první 3 strany pro debug
                if (allParties.length > 0) {
                    debugLog('📊 Ukázka prvních 3 stran (raw):', allParties.slice(0, 3));
                }
                
                // Zpracování dat - NEZFILTROVAT, zobrazit vše
                const processedParties = [];
                
                allParties.forEach((party, index) => {
                    // Použít shortName8 pokud existuje, jinak shortName nebo name
                    let name = party.shortName8 || party.shortName || party.name || `Strana ${index + 1}`;
                    
                    // Debug každé strany
                    debugLog(`📊 Strana ${index + 1}: shortName8="${party.shortName8}", name="${name}"`);
                    
                    // Přeskočit pouze pokud je název úplně prázdný
                    if (!name || name.trim().length === 0) {
                        debugLog(`⚠️ Přeskakuji stranu ${index + 1} - prázdný název`);
                        return;
                    }
                    
                    // Debug - přidat stranu do seznamu
                    debugLog(`✅ Přidávám stranu: "${name}"`);
                    
                    // Omezit délku názvu na maximum 20 znaků
                    if (name.length > 20) {
                        name = name.substring(0, 17) + '...';
                    }
                    
                    // Opravit kódování POUZE pokud je potřeba
                    if (needsFixing) {
                        name = fixEncoding(name);
                    }
                    
                    // Odstranit problematické unicode znaky
                    name = name
                        .replace(/…/g, '...')  // Nahradit unicode tři tečky
                        .replace(/—/g, '-')    // Nahradit unicode pomlčku
                        .replace(/"/g, '"')    // Nahradit unicode uvozovky
                        .replace(/"/g, '"')
                        .replace(/'/g, "'")
                        .replace(/'/g, "'")
                        .replace(/[\u2000-\u206F]/g, '')  // Odstranit speciální formátovací znaky
                        .replace(/[\u2E00-\u2E7F]/g, '')  // Odstranit doplňkovou interpunkci
                        .trim();
                    
                    // Získat barvu z různých možných polí
                    let color = party.vParty?.color || 
                               party.color || 
                               party.partyColor ||
                               party.colour ||
                               '#6c757d';
                    
                    // Ošetřit barvu - přidat # pokud chybí
                    if (color && !color.startsWith('#')) {
                        color = '#' + color;
                    }
                    
                    // Přeskočit šedé barvy (#bebebe) a přidělit náhodnou
                    if (color === '#bebebe' || color === '#6c757d') {
                        // Generovat barvu na základě názvu strany pro konzistenci
                        const hash = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                        const hue = (hash * 137) % 360; // Pseudonáhodné ale konzistentní
                        color = `hsl(${hue}, 65%, 50%)`;
                        debugLog(`🎨 Strana "${name}" má šedou barvu, přiděluji: ${color}`);
                    }
                    
                    const processedParty = {
                        shortName8: name,
                        color: color,
                        votes: party.votes || party.totalVotes || 0,
                        votesPercent: party.votesPercent || party.percent || party.percentage || 0,
                        numOfMandates: party.numOfMandates || party.mandates || party.seats || 0
                    };
                    
                    processedParties.push(processedParty);
                    
                    // Debug všechny strany
                    debugLog(`📊 Strana ${index + 1}/${allParties.length}: "${name}", barva: ${color}`);
                });

                // Seřadit podle procent hlasů (sestupně - od nejvyšší po nejnižší)
                processedParties.sort((a, b) => (b.votesPercent || 0) - (a.votesPercent || 0));

                crData = {
                    turnout: data.turnout || {},
                    parties: processedParties
                };
                
                debugLog(`✅ ČR data připravena: ${crData.parties.length} stran`);
                
                // Debug element se nepoužívá
                
                startCrCrawl();
                
            } catch (error) {
                debugLog('❌ Kritická chyba při načítání dat:', error);
                
                // Rozšířený fallback - testovací data
                crData = {
                    turnout: { voterTurnout: 0.0, precinctsFinishedPercent: 0.0 },
                    parties: generateFallbackParties()
                };
                
                debugLog(`✅ Fallback data připravena: ${crData.parties.length} stran`);
                
                // Debug element se nepoužívá
                
                startCrCrawl();
            }
        }

        function generateFallbackParties() {
            // Generovat 26+ testovacích stran se správnými českými znaky
            const parties = [];
            const baseParties = [
                { name: "ANO", color: "#261060" },
                { name: "SPOLU", color: "#00EA29" },
                { name: "STAN", color: "#B90E5E" },
                { name: "Piráti", color: "#6E6E6E" },
                { name: "SPD", color: "#C05F2F" },
                { name: "PŘÍSAHA", color: "#0240C6" },
                { name: "Stačilo!", color: "#F90A0E" },
                { name: "KSČM", color: "#DC143C" },
                { name: "AUTO", color: "#19A2E2" },
                { name: "ČSSD", color: "#f9932e" },
                { name: "ČR1", color: "#808080" },
                { name: "Levice", color: "#B22222" },
                { name: "Švýcarská dem.", color: "#4169E1" },
                { name: "MZH", color: "#FFD700" },
                { name: "SMSka", color: "#00CED1" },
                { name: "BPS", color: "#98FB98" },
                { name: "Kruh", color: "#DDA0DD" },
                { name: "Volt", color: "#FF69B4" },
                { name: "Generace", color: "#20B2AA" },
                { name: "PB", color: "#F0E68C" },
                { name: "JaSaN", color: "#B0C4DE" },
                { name: "Koruna Česká", color: "#DAA520" },
                { name: "HOP Hydra", color: "#CD5C5C" },
                { name: "Rebelové", color: "#8B4513" },
                { name: "Voluntia", color: "#9370DB" },
                { name: "VÁZVA", color: "#3CB371" },
                { name: "Nevolte Urza.cz", color: "#FF6347" }
            ];
            
            return baseParties.map((party, index) => ({
                shortName8: party.name,
                color: party.color,
                votes: Math.floor(Math.random() * 100000),
                votesPercent: Math.random() * 10,
                numOfMandates: index < 5 ? Math.floor(Math.random() * 30) : 0
            }));
        }

        function startCrCrawl() {
            if (!crData) {
                debugLog('⚠️ Žádná data k zobrazení');
                return;
            }
            
            // Aktualizovat ČR header
            const crHeaderStats = document.getElementById('crHeaderStats');
            const turnout = crData.turnout || {};
            const counted = turnout.precinctsFinishedPercent || 0;
            const voterTurnout = turnout.voterTurnout || 0;
            
            crHeaderStats.innerHTML = `sečteno: ${formatPercent(counted)}%, účast: ${formatPercent(voterTurnout)}%`;
            
            // Generovat ČR crawl content
            generateCrCrawlContent();
        }

        function generateCrCrawlContent() {
            const container = document.getElementById('crPartiesContainer');
            
            if (!crData || !crData.parties || crData.parties.length === 0) {
                container.innerHTML = '<div class="loading">Žádná data pro ČR</div>';
                debugLog('⚠️ Žádné strany k zobrazení');
                return;
            }
            
            let content = '';
            const partyCount = crData.parties.length;
            
            debugLog(`🎨 Začínám generovat HTML pro ${partyCount} stran`);
            debugLog('📊 První 3 strany pro kontrolu:', crData.parties.slice(0, 3));
            
            // Smooth update - přidat updating class (jako v krajích)
            container.classList.add('updating');
            
            setTimeout(() => {
                let content = '';
                
                // Vytvořit obsah pouze jednou (ne opakování) - jako v krajích
                crData.parties.forEach((party, index) => {
                    // Omezit název na 8 znaků včetně mezer
                    const displayName = party.shortName8.length > 8 ? party.shortName8.substring(0, 8) + "." : party.shortName8;
                    const percent = formatPercent(party.votesPercent);
                    const mandates = party.numOfMandates || 0;
                    
                    // Bezpečné escapování HTML znaků
                    const safeName = displayName
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                    
                    content += `
                        <div class="cr-party-block" style="border-left-color: ${party.color};">
                            <div class="cr-party-header">
                                <div class="cr-party-name">${safeName}</div>
                                <div class="cr-party-mandates">
                                    ${mandates}
                                    <svg viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#212529" class="cr-mandate-icon">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <title>profile [#1341]</title>
                                            <desc>Created with Sketch.</desc>
                                            <defs></defs>
                                            <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                <g id="Dribbble-Light-Preview" transform="translate(-180.000000, -2159.000000)" fill="#212529">
                                                    <g id="icons" transform="translate(56.000000, 160.000000)">
                                                        <path d="M134,2008.99998 C131.783496,2008.99998 129.980955,2007.20598 129.980955,2004.99998 C129.980955,2002.79398 131.783496,2000.99998 134,2000.99998 C136.216504,2000.99998 138.019045,2002.79398 138.019045,2004.99998 C138.019045,2007.20598 136.216504,2008.99998 134,2008.99998 M137.775893,2009.67298 C139.370449,2008.39598 140.299854,2006.33098 139.958235,2004.06998 C139.561354,2001.44698 137.368965,1999.34798 134.722423,1999.04198 C131.070116,1998.61898 127.971432,2001.44898 127.971432,2004.99998 C127.971432,2006.88998 128.851603,2008.57398 130.224107,2009.67298 C126.852128,2010.93398 124.390463,2013.89498 124.004634,2017.89098 C123.948368,2018.48198 124.411563,2018.99998 125.008391,2018.99998 C125.519814,2018.99998 125.955881,2018.61598 126.001095,2018.10898 C126.404004,2013.64598 129.837274,2010.99998 134,2010.99998 C138.162726,2010.99998 141.595996,2013.64598 141.998905,2018.10898 C142.044119,2018.61598 142.480186,2018.99998 142.991609,2018.99998 C143.588437,2018.99998 144.051632,2018.48198 143.995366,2017.89098 C143.609537,2013.89498 141.147872,2010.93398 137.775893,2009.67298" id="profile-[#1341]"></path>
                                                    </g>
                                                </g>
                                            </g>
                                        </g>
                                    </svg>
                                </div>
                            </div>
                            <div class="cr-party-percent">${percent}%</div>
                        </div>
                    `;
                    
                    // Debug každé 10. strany
                    if (index % 10 === 0) {
                        debugLog(`📦 Blok ${index}: "${displayName}"`);
                    }
                });
                
                // Přidat neviditelný sentinel blok na konec (jako marker pro konec crawlu)
                content += `
                    <div id="cr-crawl-sentinel" class="cr-party-block" style="
                        width: 160px !important;
                        min-width: 160px !important;
                        background: transparent !important;
                        border: none !important;
                        opacity: 0 !important;
                        pointer-events: none !important;
                    ">
                        <div class="cr-party-header">
                            <div class="cr-party-name" style="opacity: 0;"></div>
                            <div class="cr-party-mandates" style="opacity: 0;"></div>
                        </div>
                        <div class="cr-party-percent" style="opacity: 0;"></div>
                    </div>
                `;
                
                container.innerHTML = content;
                container.classList.remove('updating');
                
                // Počet vygenerovaných bloků
                const blockCount = container.querySelectorAll('.cr-party-block').length;
                debugLog(`✅ Vygenerováno ${blockCount} bloků stran (${partyCount} + 1 sentinel)`);
                debugLog(`✅ Celkem ${partyCount} stran + sentinel (jako v krajích)`);
                
                // Kontrola, zda se všechny bloky správně vykreslily
                if (blockCount !== partyCount + 1) {
                    debugLog(`⚠️ PROBLÉM: Očekáváno ${partyCount + 1} bloků, ale vykresleno pouze ${blockCount}!`);
                    debugLog('🔍 Možná některá strana má problematický název který rozbíjí HTML');
                    
                    // Najít problematické strany
                    crData.parties.forEach((party, index) => {
                        if (party.shortName8 && (party.shortName8.includes('<') || 
                            party.shortName8.includes('>') || 
                            party.shortName8.includes('"') ||
                            party.shortName8.includes("'") ||
                            party.shortName8.includes('/') ||
                            party.shortName8.includes('\\'))) {
                            debugLog(`⚠️ Strana ${index} má problematické znaky: "${party.shortName8}"`);
                        }
                    });
                }
                
                // Nastavit monitoring pro sentinel blok
                setupCrSentinelMonitoring();

                // Spustit animaci po načtení obsahu
                startCrCrawlAnimation();

            }, 150);
        }

        // Globální proměnná pro monitoring ČR animace
        let crAnimationMonitorId = null;

        function setupCrSentinelMonitoring() {
            // Zrušit starý monitoring pokud existuje
            if (crAnimationMonitorId) {
                cancelAnimationFrame(crAnimationMonitorId);
                crAnimationMonitorId = null;
            }

            const sentinelElement = document.getElementById('cr-crawl-sentinel');
            if (!sentinelElement) {
                debugLog('⚠️ CR Sentinel element nenalezen');
                return;
            }

            let lastCheck = Date.now();
            let hasPassedViewport = false;

            // Monitoring funkcí pomocí requestAnimationFrame
            function monitorSentinel() {
                const now = Date.now();

                // Kontrolovat každých 100ms pro performance
                if (now - lastCheck > 100) {
                    const rect = sentinelElement.getBoundingClientRect();
                    const isCompletelyLeft = rect.right < 0;
                    lastCheck = now;

                    // Když sentinel úplně zmizel vlevo
                    if (isCompletelyLeft && !hasPassedViewport) {
                        hasPassedViewport = true;

                        debugLog('🎯 CR Sentinel zmizel - restart crawlu');

                        // Zastavit monitoring
                        cancelAnimationFrame(crAnimationMonitorId);
                        crAnimationMonitorId = null;

                        // Okamžitě restartovat crawl
                        setTimeout(() => {
                            loadCrData();
                        }, 100);

                        return; // Ukončit monitoring
                    }
                }

                // Pokračovat v monitoringu
                crAnimationMonitorId = requestAnimationFrame(monitorSentinel);
            }

            // Spustit monitoring
            crAnimationMonitorId = requestAnimationFrame(monitorSentinel);
            debugLog('🔍 CR Sentinel monitoring spuštěn');
        }

        function startCrCrawlAnimation() {
            const container = document.getElementById('crPartiesContainer');

            // Vypočítat šířky
            const viewportWidth = window.innerWidth;
            const contentWidth = container.scrollWidth;

            debugLog(`🎬 Start animace - viewport: ${viewportWidth}px, content: ${contentWidth}px`);
            debugLog(`🎬 Počet bloků v kontejneru: ${container.querySelectorAll('.cr-party-block').length}`);

            // Vypočítat správný konečný translateX tak, aby poslední prvek úplně zmizel vlevo
            const finalTranslatePercent = -100 - (contentWidth / viewportWidth * 100);

            // Vypočítat dobu animace (rychlost: 80px za sekundu)
            const totalDistance = viewportWidth + contentWidth;
            const animationDuration = Math.max(totalDistance / 80, 15);

            debugLog(`🎬 Animace: ${animationDuration}s, konec: ${finalTranslatePercent}%`);

            // Vytvořit dynamické CSS keyframe
            const keyframeName = 'cr-scroll-left-' + Date.now();
            const keyframeCSS = `
                @keyframes ${keyframeName} {
                    0% { transform: translateX(100%); }
                    100% { transform: translateX(${finalTranslatePercent}%); }
                }
            `;

            // Přidat CSS do head
            const style = document.createElement('style');
            style.textContent = keyframeCSS;
            document.head.appendChild(style);

            // Resetovat pozici a animaci
            container.style.transform = 'translateX(100%)';
            container.style.animation = 'none';

            // Spustit animaci
            setTimeout(() => {
                container.style.animation = `${keyframeName} ${animationDuration}s linear`;
                debugLog(`🎬 Animace spuštěna: ${keyframeName} ${animationDuration}s linear`);

                // FALLBACK: Přidat animationend listener jako záložní řešení
                const handleAnimationEnd = (event) => {
                    if (event.target !== container) return;

                    // Odebrat listener
                    container.removeEventListener('animationend', handleAnimationEnd);

                    // Pouze pokud monitoring selhal (stále běží)
                    if (crAnimationMonitorId) {
                        debugLog('⚠️ Animace skončila, ale sentinel monitoring stále běží - fallback restart');
                        // Zrušit neúspěšný monitoring
                        cancelAnimationFrame(crAnimationMonitorId);
                        crAnimationMonitorId = null;

                        // Pokračovat restartem
                        setTimeout(() => {
                            loadCrData();
                        }, 100);
                    }
                };

                container.addEventListener('animationend', handleAnimationEnd);

                // Vyčistit keyframe po animaci
                setTimeout(() => {
                    try {
                        if (style.parentNode) {
                            document.head.removeChild(style);
                        }
                    } catch (error) {
                        // Keyframe cleanup skipped
                    }
                }, animationDuration * 1000 + 1000);
            }, 50);
        }

        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🚀 Aplikace spuštěna');
            loadCrData();
        });

        // Refresh dat se spouští automaticky po dokončení každé animace

        // Klávesová zkratka pro debug (Ctrl+D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                const panel = document.getElementById('debugPanel');
                if (panel) {
                    panel.classList.toggle('hidden');
                }
            }
        });
    </script>
</body>
</html>