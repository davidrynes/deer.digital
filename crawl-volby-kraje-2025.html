<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawl ÄŒR + Kraje 2025</title>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <!-- 
        CRAWL PRO VOLBY 2025
        
        API endpointy:
        - ÄŒR: https://api.elections.seznam.cz/parliament/2025/results/cr
        - Kraje: https://api.elections.seznam.cz/parliament/2025/regions
        
        CORS Å™eÅ¡enÃ­: 
        1. PokusÃ­ se o pÅ™Ã­mÃ© naÄtenÃ­ z API
        2. PÅ™i selhÃ¡nÃ­ pouÅ¾ije CORS proxy (cors-anywhere.herokuapp.com)
        3. PÅ™i selhÃ¡nÃ­ obou pouÅ¾ije fallback testovacÃ­ data
        
        Zobrazuje vÅ¡echny strany s barvami, null hodnoty jako nuly.
        Pro aktivaci CORS proxy navÅ¡tivte: https://cors-anywhere.herokuapp.com/corsdemo
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: transparent;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: flex-end;
        }

        .dashboard-container {
            width: 100%;
            height: 240px; /* ZvÄ›tÅ¡eno pro vÄ›tÅ¡Ã­ crawly */
            background: transparent;
            display: flex;
            flex-direction: column;
            position: fixed;
            bottom: 0;
            left: 0;
        }

        /* Kontejner pro ÄŒR crawl */
        .cr-crawl-container {
            width: 100%;
            height: 80px; /* ZvÄ›tÅ¡eno z 60px */
            background: transparent;
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #dee2e6;
        }

        /* Header pro ÄŒR crawl */
        .cr-header {
            height: 30px; /* ZvÄ›tÅ¡eno z 25px */
            background: #e92929;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            padding: 12px 20px; /* ZvÄ›tÅ¡en padding */
        }

        .cr-header-content {
            font-size: 20px; /* ZvÄ›tÅ¡eno z 14px */
            font-weight: 600;
            color: #fafafa;
        }

        .cr-header-separator {
            margin: 0 12px;
            color: #fafafa;
            font-weight: 400;
        }

        .cr-header-stats {
            font-size: 16px; /* ZvÄ›tÅ¡eno z 12px */
            font-weight: 500;
            color: #fafafa;
        }

        /* Kontejner pro parties ÄŒR crawl */
        .cr-parties-container {
            display: flex;
            height: 50px; /* ZvÄ›tÅ¡eno z 35px */
            align-items: center;
            white-space: nowrap;
            padding: 0 20px;
            transform: translateX(100%);
        }

        /* Party bloky pro ÄŒR crawl - skuteÄnÄ› flexibilnÃ­ podle obsahu */
        .cr-party-block {
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            padding: 6px 16px; /* KompaktnÃ­ padding */
            margin: 0;
            width: fit-content; /* PÅ™esnÄ› podle obsahu */
            position: relative;
            background: white;
            border-left: 4px solid; /* ZvÄ›tÅ¡en border */
            border-right: 1px solid #e9ecef;
            text-align: left;
            height: 50px; /* ZvÄ›tÅ¡eno z 35px */
            box-sizing: border-box;
        }

        .cr-party-name {
            font-size: 16px; /* ZvÄ›tÅ¡eno z 12px */
            font-weight: 700; /* ZvÄ›tÅ¡ena vÃ¡ha */
            color: #212529;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap; /* NÃ¡zev se nezlomÃ­ na vÃ­ce Å™Ã¡dkÅ¯ */
            margin-right: 16px; /* VÄ›tÅ¡Ã­ mezera mezi nÃ¡zvem a procenty */
            display: inline-block; /* PevnÃ½ blok */
        }

        .cr-party-percent {
            font-size: 18px; /* ZvÄ›tÅ¡eno z 14px */
            font-weight: 800; /* ZvÄ›tÅ¡ena vÃ¡ha */
            color: #212529;
            white-space: nowrap; /* Procenta se nezlomÃ­ */
            flex-shrink: 0; /* Procenta si zachovajÃ­ svou velikost */
        }

        .header {
            height: 45px; /* ZvÄ›tÅ¡eno z 35px */
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            padding: 12px 20px; /* ZvÄ›tÅ¡en padding */
        }

        .header-content {
            font-size: 20px; /* ZvÄ›tÅ¡eno z 16px */
            font-weight: 700;
            color: #212529;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }

        .header-separator {
            margin: 0 12px;
            color: #6c757d;
            font-weight: 400;
        }

        .header-stats {
            font-size: 16px; /* ZvÄ›tÅ¡eno z 14px */
            font-weight: 600;
            color: #495057;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }

        /* Animace pro slide out */
        .header-content.slide-out {
            transform: translateX(-30px);
            opacity: 0;
        }

        .header-stats.slide-out {
            transform: translateX(30px);
            opacity: 0;
        }

        /* Animace pro slide in */
        .header-content.slide-in {
            transform: translateX(30px);
            opacity: 0;
        }

        .header-stats.slide-in {
            transform: translateX(-30px);
            opacity: 0;
        }

        .parties-container {
            display: flex;
            height: 115px; /* ZvÄ›tÅ¡eno z 95px */
            align-items: center;
            white-space: nowrap;
            /* Animace se nastavuje dynamicky podle obsahu */
            padding: 0 20px;
            transform: translateX(100%); /* ZaÄÃ­nÃ¡ vpravo */
        }

        .party-block {
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px 16px;
            margin: 0;
            width: 220px;
            position: relative;
            background: white;
            border-left: 4px solid;
            border-right: 1px solid #e9ecef;
            text-align: left;
            height: 115px; /* ZvÄ›tÅ¡eno z 95px */
            box-sizing: border-box;
        }

        .party-name {
            font-size: 22px; /* ZvÄ›tÅ¡eno z 18px */
            font-weight: 700;
            color: #212529;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            display: inline-block;
        }

        .party-percent {
            font-size: 36px; /* ZvÄ›tÅ¡eno z 22px */
            font-weight: 800;
            color: #212529;
            white-space: nowrap;
            text-align: right;
            align-self: flex-end;
        }

        /* Divider mezi opakovÃ¡nÃ­mi */
        .divider {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 80px; /* ZvÄ›tÅ¡eno z 60px */
            height: 95px; /* ZvÄ›tÅ¡eno z 76px */
        }

        .divider-dot {
            width: 5px; /* ZvÄ›tÅ¡eno z 4px */
            height: 5px; /* ZvÄ›tÅ¡eno z 4px */
            background: #ced4da;
            border-radius: 50%;
            margin: 0 4px; /* ZvÄ›tÅ¡en margin */
        }

        /* Divider pro ÄŒR crawl */
        .cr-divider {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* ZvÄ›tÅ¡eno z 30px */
            height: 50px; /* ZvÄ›tÅ¡eno z 35px */
        }

        .cr-divider-dot {
            width: 3px; /* ZvÄ›tÅ¡eno z 2px */
            height: 3px; /* ZvÄ›tÅ¡eno z 2px */
            background: #ced4da;
            border-radius: 50%;
            margin: 0 3px; /* ZvÄ›tÅ¡en margin */
        }

        /* Loading state */
        .loading {
            color: #666;
            text-align: center;
            padding: 35px; /* ZvÄ›tÅ¡en */
            font-size: 16px; /* ZvÄ›tÅ¡eno z 14px */
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Loading pro ÄŒR crawl */
        .cr-parties-container .loading {
            padding: 15px; /* ZvÄ›tÅ¡en z 10px */
            font-size: 14px; /* ZvÄ›tÅ¡eno z 12px */
        }

        /* Animace - bude se nastavovat dynamicky v JavaScript */
        @keyframes scroll-left-dynamic {
            0% {
                transform: translateX(100%); /* ZaÄÃ­nÃ¡ vpravo */
            }
            100% {
                /* Konec se nastavuje dynamicky aby poslednÃ­ prvek ÃºplnÄ› zmizel */
            }
        }

        /* Pulsing animace pro "ÄekÃ¡nÃ­ na data" */
        @keyframes waiting-pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* Sentinel blok - zajistit ÃºplnÃ© skrytÃ­ */
        #crawl-sentinel {
            opacity: 0 !important;
            background: transparent !important;
            border: none !important;
            visibility: hidden !important;
        }

        /* Sentinel blok - ÃºplnÄ› skrytÃ½ */
        .party-block#crawl-sentinel {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        .party-percent {
            animation: waiting-pulse 2s infinite;
        }

        /* Animace pro ÄŒR crawl */
        @keyframes cr-scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .cr-parties-container.animate {
            animation: cr-scroll-left 60s linear infinite; /* Zpomaleno z 30s na 60s */
        }

        /* ResponsivnÃ­ Ãºpravy */
        @media (max-width: 768px) {
            .dashboard-container {
                height: 180px; /* Upraveno pro vÄ›tÅ¡Ã­ crawly */
            }

            .cr-crawl-container {
                height: 60px; /* ZvÄ›tÅ¡eno */
            }

            .cr-header {
                height: 25px; /* ZvÄ›tÅ¡eno */
                padding: 4px 15px;
            }

            .cr-header-content {
                font-size: 20px; /* ZvÄ›tÅ¡eno */
            }

            .cr-header-stats {
                font-size: 12px; /* ZvÄ›tÅ¡eno */
            }

            .cr-header-separator {
                margin: 0 8px; /* MenÅ¡Ã­ mezera na mobilu */
            }

            .cr-parties-container {
                height: 35px; /* ZvÄ›tÅ¡eno */
            }

            .cr-party-block {
                width: fit-content; /* PÅ™esnÄ› podle obsahu i na mobilu */
                height: 35px; /* ZvÄ›tÅ¡eno */
                padding: 4px 12px; /* KompaktnÃ­ padding pro mobil */
            }

            .cr-party-name {
                font-size: 12px; /* ZvÄ›tÅ¡eno */
            }

            .cr-party-percent {
                font-size: 14px; /* ZvÄ›tÅ¡eno */
            }
            
            .header {
                height: 35px; /* ZvÄ›tÅ¡eno */
                padding: 8px 15px; /* ZvÄ›tÅ¡en */
            }
            
            .header-content {
                font-size: 16px; /* ZvÄ›tÅ¡eno */
            }
            
            .header-stats {
                font-size: 14px; /* ZvÄ›tÅ¡eno */
            }

            .header-separator {
                margin: 0 8px; /* MenÅ¡Ã­ mezera na mobilu */
            }
            
            .parties-container {
                height: 90px; /* ZvÄ›tÅ¡eno */
            }
            
            .party-block {
                width: fit-content;
                height: 90px; /* ZvÄ›tÅ¡eno */
                padding: 4px 12px;
            }
            
            .party-name {
                font-size: 16px; /* ZvÄ›tÅ¡eno */
            }
            
            .party-percent {
                font-size: 22px; /* ZvÄ›tÅ¡eno */
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- ÄŒR crawl - hornÃ­ tenÄÃ­ -->
        <div class="cr-crawl-container">
            <div class="cr-header">
                <div class="cr-header-content" id="crHeaderContent">ÄŒeskÃ¡ republika</div>
                <div class="cr-header-separator">|</div>
                <div class="cr-header-stats" id="crHeaderStats">seÄteno: 0,00%, ÃºÄast: 0,00%</div>
            </div>
            <div class="cr-parties-container" id="crPartiesContainer">
                <div class="loading">NaÄÃ­tÃ¡m celkovÃ© vÃ½sledky ÄŒR 2025...</div>
            </div>
        </div>

        <!-- KrajskÃ½ crawl - spodnÃ­ -->
        <div class="header">
            <div class="header-content" id="headerContent">NaÄÃ­tÃ¡m kraje...</div>
            <div class="header-separator">|</div>
            <div class="header-stats" id="headerStats">seÄteno: 0,00%, ÃºÄast: 0,00%</div>
        </div>
        <div class="parties-container" id="partiesContainer">
            <div class="loading">PÅ™ipojuji k API krajÅ¯ 2025...</div>
        </div>
    </div>

    <script>
        let regionsData = [];
        let currentRegionIndex = 0;
        let currentRegion = null;
        let crData = null;

        function formatNumber(num) {
            if (num === null || num === undefined) return "0";
            return num.toLocaleString('cs-CZ');
        }

        function formatPercent(num) {
            if (num === null || num === undefined) return "0.0";
            return num.toFixed(2);
        }

        function getMandatesText(num) {
            if (num === null || num === undefined || num === 0) return "mandÃ¡tÅ¯";
            
            // ÄŒeskÃ© skloÅˆovÃ¡nÃ­
            const lastDigit = num % 10;
            const lastTwoDigits = num % 100;
            
            // VÃ½jimky pro 11, 12, 13, 14
            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return "mandÃ¡tÅ¯";
            }
            
            // ZÃ¡kladnÃ­ pravidla
            if (lastDigit === 1) {
                return "mandÃ¡t";
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                return "mandÃ¡ty";
            } else {
                return "mandÃ¡tÅ¯";
            }
        }

        function updateHeader(region) {
            const headerContent = document.getElementById('headerContent');
            const headerStats = document.getElementById('headerStats');
            
            const turnout = region.turnout || {};
            const counted = turnout.precinctsFinishedPercent || 0;
            const voterTurnout = turnout.voterTurnout || 0;
            
            
            // FÃ¡ze 1: Slide out (mizÃ­ vlevo/vpravo)
            headerContent.classList.add('slide-out');
            headerStats.classList.add('slide-out');
            
            setTimeout(() => {
                // FÃ¡ze 2: ZmÄ›na obsahu
                headerContent.innerHTML = `${region.name}`;
                headerStats.innerHTML = `seÄteno: ${formatPercent(counted)}%, ÃºÄast: ${formatPercent(voterTurnout)}%`;
                
                // FÃ¡ze 3: PÅ™Ã­prava slide in (zaÄÃ­nÃ¡ z opaÄnÃ© strany)
                headerContent.classList.remove('slide-out');
                headerStats.classList.remove('slide-out');
                headerContent.classList.add('slide-in');
                headerStats.classList.add('slide-in');
                
                // FÃ¡ze 4: Slide in (vjÃ­Å¾dÃ­ do normÃ¡lnÃ­ pozice)
                setTimeout(() => {
                    headerContent.classList.remove('slide-in');
                    headerStats.classList.remove('slide-in');
                }, 50);
                
                }, 200); // Doba slide-out animace (zkrÃ¡ceno z 300ms)
        }

        async function loadCrData() {
            const isDevMode = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
            const debugLog = isDevMode ? console.log : () => {};
            
            debugLog('ğŸ”„ NaÄÃ­tÃ¡m data za celou ÄŒR...');
            
            try {
                let response;
                let data;
                
                const corsProxies = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                try {
                    // Pokus o pÅ™Ã­mÃ© naÄtenÃ­
                    debugLog('ğŸ¯ ZkouÅ¡Ã­m pÅ™Ã­mÃ© naÄtenÃ­ ÄŒR dat...');
                    response = await fetch('https://api.elections.seznam.cz/parliament/2025/results/cr');
                    if (!response.ok) throw new Error('Direct fetch failed');
                    data = await response.json();
                    debugLog('âœ… PÅ™Ã­mÃ© naÄtenÃ­ ÄŒR dat ÃºspÄ›Å¡nÃ©!');
                } catch (directError) {
                    debugLog('âš ï¸ PÅ™Ã­mÃ© naÄtenÃ­ ÄŒR dat selhalo, zkouÅ¡Ã­m CORS proxy...');
                    
                    let lastError = directError;
                    
                    for (let i = 0; i < corsProxies.length; i++) {
                        try {
                            debugLog(`ğŸ”„ ÄŒR Proxy ${i + 1}/${corsProxies.length}: ${corsProxies[i].slice(0, 30)}...`);
                            const proxyUrl = corsProxies[i] + 'https://api.elections.seznam.cz/parliament/2025/results/cr';
                            response = await fetch(proxyUrl);
                            
                            if (!response.ok) {
                                if (response.status === 403 && corsProxies[i].includes('cors-anywhere')) {
                                    throw new Error('CORS-anywhere requires permission. Visit https://cors-anywhere.herokuapp.com/corsdemo first.');
                                }
                                throw new Error(`ÄŒR Proxy ${i + 1} failed with status ${response.status}`);
                            }
                            
                            data = await response.json();
                            debugLog(`âœ… ÄŒR Proxy ${i + 1} ÃºspÄ›Å¡nÃ©!`);
                            break;
                            
                        } catch (proxyError) {
                            debugLog(`âŒ ÄŒR Proxy ${i + 1} selhalo: ${proxyError.message}`);
                            lastError = proxyError;
                            
                            if (i === corsProxies.length - 1) {
                                throw new Error(`All ÄŒR proxy attempts failed. Last error: ${lastError.message}`);
                            }
                        }
                    }
                }
                
                // Zpracovat data
                crData = {
                    turnout: data.turnout,
                    parties: data._items
                        .filter(party => party.shortName8 && party.shortName8.length > 1) // Zobrazit vÅ¡echny strany s nÃ¡zvem
                        .map(party => ({
                            shortName8: party.shortName8,
                            color: party.vParty.color || '#6c757d',
                            votes: party.votes,
                            votesPercent: party.votesPercent,
                            numOfMandates: party.numOfMandates || 0
                        }))
                        .sort((a, b) => (b.votesPercent || 0) - (a.votesPercent || 0)) // Å˜azenÃ­ s null jako 0
                };
                
                debugLog(`âœ… ÄŒR data zpracovÃ¡na: ${crData.parties.length} stran`);
                
                // Spustit ÄŒR crawl
                startCrCrawl();
                
            } catch (error) {
                debugLog(`âŒ NaÄÃ­tÃ¡nÃ­ ÄŒR dat selhalo: ${error.message}`);
                
                // Fallback pro ÄŒR data 2025 (pÅ™ed volbami - zobrazit s nulami)
                crData = {
                    turnout: { voterTurnout: 0.0, precinctsFinishedPercent: 0.0 },
                    parties: [
                        { shortName8: "ANO", color: "#261060", votes: null, votesPercent: null, numOfMandates: 0 },
                        { shortName8: "SPOLU", color: "#00EA29", votes: null, votesPercent: null, numOfMandates: 0 },
                        { shortName8: "PirÃ¡ti", color: "#6E6E6E", votes: null, votesPercent: null, numOfMandates: 0 },
                        { shortName8: "SPD", color: "#C05F2F", votes: null, votesPercent: null, numOfMandates: 0 },
                        { shortName8: "PÅ˜ÃSAHA", color: "#0240C6", votes: null, votesPercent: null, numOfMandates: 0 },
                        { shortName8: "StaÄilo!", color: "#F90A0E", votes: null, votesPercent: null, numOfMandates: 0 }
                    ]
                };
                
                debugLog(`âœ… ÄŒR Fallback data pÅ™ipravena: ${crData.parties.length} stran`);
                startCrCrawl();
            }
        }

        function startCrCrawl() {
            if (!crData) return;
            
            // Aktualizovat ÄŒR header
            const crHeaderStats = document.getElementById('crHeaderStats');
            const turnout = crData.turnout || {};
            const counted = turnout.precinctsFinishedPercent || 0;
            const voterTurnout = turnout.voterTurnout || 0;
            
            crHeaderStats.innerHTML = `seÄteno: ${formatPercent(counted)}%, ÃºÄast: ${formatPercent(voterTurnout)}%`;
            
            // Generovat ÄŒR crawl content
            generateCrCrawlContent();
        }

        function generateCrCrawlContent() {
            const crPartiesContainer = document.getElementById('crPartiesContainer');

            if (!crData || !crData.parties) {
                crPartiesContainer.innerHTML = '<div class="loading">Å½Ã¡dnÃ¡ data pro ÄŒR</div>';
                return;
            }

            crPartiesContainer.classList.add('updating');

            setTimeout(() => {
                let content = '';

                // VytvoÅ™it obsah pouze jednou (ne opakovÃ¡nÃ­)
                crData.parties.forEach((party, index) => {
                    const displayName = party.shortName8;
                    const percent = formatPercent(party.votesPercent);

                    content += `
                        <div class="cr-party-block" style="border-left-color: ${party.color};">
                            <div class="cr-party-name">${displayName}</div>
                            <div class="cr-party-percent">${percent}%</div>
                        </div>
                    `;
                });

                // PÅ™idat neviditelnÃ½ sentinel blok
                content += `
                    <div id="cr-crawl-sentinel" class="cr-party-block" style="
                        width: 160px !important;
                        min-width: 160px !important;
                        background: transparent !important;
                        border: none !important;
                        opacity: 0 !important;
                        pointer-events: none !important;
                    ">
                        <div class="cr-party-name" style="opacity: 0;"></div>
                        <div class="cr-party-percent" style="opacity: 0;"></div>
                    </div>
                `;

                crPartiesContainer.innerHTML = content;
                crPartiesContainer.classList.remove('updating');

                // Nastavit monitoring pro sentinel blok
                setupCrSentinelMonitoring();

                // Spustit animaci
                startCrCrawlAnimation();
            }, 150);
        }

        // GlobÃ¡lnÃ­ promÄ›nnÃ¡ pro monitoring ÄŒR animace
        let crAnimationMonitorId = null;

        function setupCrSentinelMonitoring() {
            if (crAnimationMonitorId) {
                cancelAnimationFrame(crAnimationMonitorId);
                crAnimationMonitorId = null;
            }

            const sentinelElement = document.getElementById('cr-crawl-sentinel');
            if (!sentinelElement) {
                return;
            }

            let lastCheck = Date.now();
            let hasPassedViewport = false;

            function monitorSentinel() {
                const now = Date.now();

                if (now - lastCheck > 100) {
                    const rect = sentinelElement.getBoundingClientRect();
                    const isCompletelyLeft = rect.right < 0;
                    lastCheck = now;

                    if (isCompletelyLeft && !hasPassedViewport) {
                        hasPassedViewport = true;

                        cancelAnimationFrame(crAnimationMonitorId);
                        crAnimationMonitorId = null;

                        setTimeout(() => {
                            loadCrData();
                        }, 100);

                        return;
                    }
                }

                crAnimationMonitorId = requestAnimationFrame(monitorSentinel);
            }

            crAnimationMonitorId = requestAnimationFrame(monitorSentinel);
        }

        function startCrCrawlAnimation() {
            const crPartiesContainer = document.getElementById('crPartiesContainer');

            const viewportWidth = window.innerWidth;
            const contentWidth = crPartiesContainer.scrollWidth;

            const finalTranslatePercent = -100 - (contentWidth / viewportWidth * 100);
            const totalDistance = viewportWidth + contentWidth;
            const animationDuration = Math.max(totalDistance / 80, 15);

            const keyframeName = 'cr-scroll-left-' + Date.now();
            const keyframeCSS = `
                @keyframes ${keyframeName} {
                    0% { transform: translateX(100%); }
                    100% { transform: translateX(${finalTranslatePercent}%); }
                }
            `;

            const style = document.createElement('style');
            style.textContent = keyframeCSS;
            document.head.appendChild(style);

            crPartiesContainer.style.transform = 'translateX(100%)';
            crPartiesContainer.style.animation = 'none';

            setTimeout(() => {
                crPartiesContainer.style.animation = `${keyframeName} ${animationDuration}s linear`;

                const handleAnimationEnd = (event) => {
                    if (event.target !== crPartiesContainer) return;

                    crPartiesContainer.removeEventListener('animationend', handleAnimationEnd);

                    if (crAnimationMonitorId) {
                        cancelAnimationFrame(crAnimationMonitorId);
                        crAnimationMonitorId = null;

                        setTimeout(() => {
                            loadCrData();
                        }, 100);
                    }
                };

                crPartiesContainer.addEventListener('animationend', handleAnimationEnd);

                setTimeout(() => {
                    try {
                        if (style.parentNode) {
                            document.head.removeChild(style);
                        }
                    } catch (error) {
                        // Cleanup skipped
                    }
                }, animationDuration * 1000 + 1000);
            }, 50);
        }

        async function loadRegionsData() {
            // Debug reÅ¾im (pouze pro development)
            const isDevMode = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
            const debugLog = isDevMode ? console.log : () => {};
            
            debugLog('ğŸ”„ NaÄÃ­tÃ¡m data krajÅ¯...');
            
            try {
                
                let response;
                let data;
                
                // Seznam CORS proxy serverÅ¯ (v poÅ™adÃ­ priority)
                const corsProxies = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://thingproxy.freeboard.io/fetch/'
                ];
                
                try {
                    // Pokus o pÅ™Ã­mÃ© naÄtenÃ­ (funguje v produkci/vMix)
                    debugLog('ğŸ¯ ZkouÅ¡Ã­m pÅ™Ã­mÃ© naÄtenÃ­...');
                    response = await fetch('https://api.elections.seznam.cz/parliament/2025/regions');
                    if (!response.ok) throw new Error('Direct fetch failed');
                    data = await response.json();
                    debugLog('âœ… PÅ™Ã­mÃ© naÄtenÃ­ ÃºspÄ›Å¡nÃ©!');
                } catch (directError) {
                    debugLog('âš ï¸ PÅ™Ã­mÃ© naÄtenÃ­ selhalo, zkouÅ¡Ã­m CORS proxy...');
                    
                    // Fallback na CORS proxy servery
                    let lastError = directError;
                    
                    for (let i = 0; i < corsProxies.length; i++) {
                        try {
                            debugLog(`ğŸ”„ Proxy ${i + 1}/${corsProxies.length}: ${corsProxies[i].slice(0, 30)}...`);
                            const proxyUrl = corsProxies[i] + 'https://api.elections.seznam.cz/parliament/2025/regions';
                            response = await fetch(proxyUrl);
                            
                            if (!response.ok) {
                                if (response.status === 403 && corsProxies[i].includes('cors-anywhere')) {
                                    // SpecifickÃ¡ zprÃ¡va pro cors-anywhere
                                    throw new Error('CORS-anywhere requires permission. Visit https://cors-anywhere.herokuapp.com/corsdemo first.');
                                }
                                throw new Error(`Proxy ${i + 1} failed with status ${response.status}`);
                            }
                            
                            data = await response.json();
                            debugLog(`âœ… Proxy ${i + 1} ÃºspÄ›Å¡nÃ©!`);
                            break; // ÃšspÄ›ch - ukonÄit smyÄku
                            
                        } catch (proxyError) {
                            debugLog(`âŒ Proxy ${i + 1} selhalo: ${proxyError.message}`);
                            lastError = proxyError;
                            
                            // Pokud je to poslednÃ­ proxy, throw error
                            if (i === corsProxies.length - 1) {
                                throw new Error(`All proxy attempts failed. Last error: ${lastError.message}`);
                            }
                            // Jinak pokraÄovat na dalÅ¡Ã­ proxy
                        }
                    }
                }
                
                
                regionsData = data._items.map(region => ({
                    number: region.number,
                    name: region.name,
                    turnout: region.turnout,
                    parties: region.parties
                        .filter(party => party.shortName8 && party.shortName8.length > 1)
                        .map(party => ({
                            shortName8: party.shortName8,
                            color: party.vParty.color || '#6c757d',
                            votes: party.results.votes,
                            votesPercent: party.results.votesPercent,
                            numOfMandates: party.numOfMandates || 0
                        }))
                        .sort((a, b) => (b.votesPercent || 0) - (a.votesPercent || 0)) // SeÅ™adit podle procent (null = 0)
                }));
                
                
                debugLog(`âœ… Data zpracovÃ¡na: ${regionsData.length} krajÅ¯`);
                
                // ZaÄÃ­t s prvnÃ­m krajem
                currentRegionIndex = 0;
                startRegionCycling();
                
            } catch (error) {
                debugLog(`âŒ NaÄÃ­tÃ¡nÃ­ dat selhalo: ${error.message}`);
                
                // Informovat uÅ¾ivatele o problÃ©mu
                if (error.message.includes('cors-anywhere requires permission')) {
                    alert('âš ï¸ CORS chyba!\n\nPro lokÃ¡lnÃ­ vÃ½voj navÅ¡tivte:\nhttps://cors-anywhere.herokuapp.com/corsdemo\n\na kliknÄ›te na "Request temporary access to the demo server".\n\nPak obnovte strÃ¡nku.');
                }
                
                debugLog('ğŸ”„ PouÅ¾Ã­vÃ¡m fallback testovacÃ­ data...');
                
                // Fallback na testovacÃ­ data 2025 (pÅ™ed volbami - zobrazit s nulami)
                regionsData = [
                    {
                        number: 1,
                        name: "HlavnÃ­ mÄ›sto Praha",
                        turnout: { voterTurnout: 0.0, precinctsFinishedPercent: 0.0 },
                        parties: [
                            { shortName8: "ANO", color: "#261060", votes: null, votesPercent: null, numOfMandates: 0 },
                            { shortName8: "SPOLU", color: "#00EA29", votes: null, votesPercent: null, numOfMandates: 0 },
                            { shortName8: "PirÃ¡ti", color: "#6E6E6E", votes: null, votesPercent: null, numOfMandates: 0 },
                            { shortName8: "SPD", color: "#C05F2F", votes: null, votesPercent: null, numOfMandates: 0 }
                        ]
                    }
                ];
                
                debugLog(`âœ… Fallback data pÅ™ipravena: ${regionsData.length} krajÅ¯`);
                startRegionCycling();
            }
        }

        function startRegionCycling() {
            if (regionsData.length === 0) return;
            
            displayCurrentRegion(false); // PrvnÃ­ naÄtenÃ­ s animacÃ­ headeru
        }

        // GlobÃ¡lnÃ­ promÄ›nnÃ¡ pro monitoring animace
        let animationMonitorId = null;

        function setupSentinelMonitoring() {
            // ZruÅ¡it starÃ½ monitoring pokud existuje
            if (animationMonitorId) {
                cancelAnimationFrame(animationMonitorId);
                animationMonitorId = null;
            }

            const sentinelElement = document.getElementById('crawl-sentinel');
            if (!sentinelElement) {
                return;
            }
            
            let lastCheck = Date.now();
            let hasPassedViewport = false;
            
            // Monitoring funkcÃ­ pomocÃ­ requestAnimationFrame
            function monitorSentinel() {
                const now = Date.now();
                
                // Kontrolovat kaÅ¾dÃ½ch 100ms pro performance
                if (now - lastCheck > 100) {
                    const rect = sentinelElement.getBoundingClientRect();
                    const isCompletelyLeft = rect.right < 0;
                    lastCheck = now;
                    
                    // KdyÅ¾ sentinel ÃºplnÄ› zmizel vlevo
                    if (isCompletelyLeft && !hasPassedViewport) {
                        hasPassedViewport = true;
                        
                        // Zastavit monitoring
                        cancelAnimationFrame(animationMonitorId);
                        animationMonitorId = null;
                        
                        // OkamÅ¾itÄ› zmÄ›nit na dalÅ¡Ã­ kraj
                        currentRegionIndex = (currentRegionIndex + 1) % regionsData.length;
                        const nextRegion = regionsData[currentRegionIndex];
                        
                        // Spustit animaci headeru
                        updateHeader(nextRegion);
                        
                        // NaÄÃ­st novÃ½ crawl
                        setTimeout(() => {
                            displayCurrentRegion(true); // Header uÅ¾ byl animovÃ¡n
                        }, 300);
                        
                        return; // UkonÄit monitoring
                    }
                }
                
                // PokraÄovat v monitoringu
                animationMonitorId = requestAnimationFrame(monitorSentinel);
            }
            
            // Spustit monitoring
            animationMonitorId = requestAnimationFrame(monitorSentinel);
        }

        function displayCurrentRegion(isHeaderAlreadyAnimated = false) {
            currentRegion = regionsData[currentRegionIndex];
            
            
            // Aktualizovat header (animace jen pokud jeÅ¡tÄ› nebyla provedena)
            if (!isHeaderAlreadyAnimated) {
                updateHeader(currentRegion);
            }
            
            // Generovat crawl obsah
            generateCrawlContent();
        }

        function generateCrawlContent() {
            const partiesContainer = document.getElementById('partiesContainer');
            
            if (!currentRegion || !currentRegion.parties) {
                partiesContainer.innerHTML = '<div class="loading">Å½Ã¡dnÃ¡ data pro aktuÃ¡lnÃ­ kraj</div>';
                return;
            }
            
            // Smooth update - pÅ™idat updating class
            partiesContainer.classList.add('updating');
            
            setTimeout(() => {
                let content = '';
                
                // VytvoÅ™it obsah pouze jednou (ne opakovÃ¡nÃ­)
                currentRegion.parties.forEach((party, index) => {
                    const displayName = party.shortName8.length > 9 ? party.shortName8.substring(0, 9) + "." : party.shortName8;
                    
                    const percent = formatPercent(party.votesPercent);
                    
                    content += `
                        <div class="party-block" style="border-left-color: ${party.color};">
                            <div class="party-name">${displayName}</div>
                            <div class="party-percent">${percent}%</div>
                        </div>
                    `;
                });
                
                // PÅ™idat VIDITELNÃ sentinel blok na konec
                content += `
                    <div id="crawl-sentinel" class="party-block" style="
                        width: 160px !important;
                        min-width: 160px !important;
                    ">
                        <div class="party-name">SENTINEL</div>
                        <div class="party-stats-row">
                            <div class="party-percent">END</div>
                            <div class="party-mandates">MARKER</div>
                        </div>
                        <div class="party-votes">BLOCK</div>
                    </div>
                `;
                
                partiesContainer.innerHTML = content;
                partiesContainer.classList.remove('updating');
                
                // Nastavit monitoring pro sentinel blok
                setupSentinelMonitoring();
                
                // Spustit animaci po naÄtenÃ­ obsahu
                startCrawlAnimation();
                
            }, 150);
        }

        function startCrawlAnimation() {
            const partiesContainer = document.getElementById('partiesContainer');
            
            // VypoÄÃ­tat Å¡Ã­Å™ky
            const viewportWidth = window.innerWidth;
            const contentWidth = partiesContainer.scrollWidth;
            
            // VypoÄÃ­tat sprÃ¡vnÃ½ koneÄnÃ½ translateX tak, aby poslednÃ­ prvek ÃºplnÄ› zmizel vlevo
            // Od -100% jeÅ¡tÄ› odeÄteme pomÄ›r Å¡Ã­Å™ky obsahu k viewportu
            const finalTranslatePercent = -100 - (contentWidth / viewportWidth * 100);
            
            // VypoÄÃ­tar dobu animace (rychlost: 80px za sekundu - pomalejÅ¡Ã­ pro lepÅ¡Ã­ Äitelnost)
            // CelkovÃ¡ vzdÃ¡lenost je od 100% doprava do finalTranslatePercent vlevo
            const totalDistance = viewportWidth + contentWidth; // v pixelech
            const animationDuration = Math.max(totalDistance / 80, 15); // sekundy (minimum 15s pro Äitelnost, rychlost 80px/s)
            
            
            // VytvoÅ™it dynamickÃ© CSS keyframe
            const keyframeName = 'scroll-left-' + Date.now();
            const keyframeCSS = `
                @keyframes ${keyframeName} {
                    0% { transform: translateX(100%); }
                    100% { transform: translateX(${finalTranslatePercent}%); }
                }
            `;
            
            // PÅ™idat keyframe do stylu
            const styleElement = document.createElement('style');
            styleElement.textContent = keyframeCSS;
            document.head.appendChild(styleElement);
            
            // Resetovat pozici na zaÄÃ¡tek (vpravo)
            partiesContainer.style.transform = 'translateX(100%)';
            partiesContainer.style.animation = 'none';
            
            // Spustit animaci
            setTimeout(() => {
                const startTime = new Date();
                const endTime = new Date(startTime.getTime() + (animationDuration * 1000));
                
                partiesContainer.style.animation = `${keyframeName} ${animationDuration}s linear`;
                
                // FALLBACK: PÅ™idat animationend listener jako zÃ¡loÅ¾nÃ­ Å™eÅ¡enÃ­
                const handleAnimationEnd = (event) => {
                    if (event.target !== partiesContainer) return;
                    
                    // Odebrat listener
                    partiesContainer.removeEventListener('animationend', handleAnimationEnd);
                    
                    // Pouze pokud monitoring selhal (stÃ¡le bÄ›Å¾Ã­)
                    if (animationMonitorId) {
                        // ZruÅ¡it neÃºspÄ›Å¡nÃ½ monitoring
                        cancelAnimationFrame(animationMonitorId);
                        animationMonitorId = null;
                        
                        // PokraÄovat zmÄ›nou kraje
                        currentRegionIndex = (currentRegionIndex + 1) % regionsData.length;
                        const nextRegion = regionsData[currentRegionIndex];
                        
                        updateHeader(nextRegion);
                        setTimeout(() => {
                            displayCurrentRegion(true);
                        }, 300);
                    }
                };
                
                partiesContainer.addEventListener('animationend', handleAnimationEnd);
                
                // VyÄistit keyframe po animaci
                setTimeout(() => {
                    try {
                        if (styleElement.parentNode) {
                            document.head.removeChild(styleElement);
                        }
                    } catch (error) {
                        // Keyframe cleanup skipped
                    }
                }, animationDuration * 1000 + 1000);
            }, 50);
        }

        // Spustit naÄÃ­tÃ¡nÃ­ dat po naÄtenÃ­ strÃ¡nky
        document.addEventListener('DOMContentLoaded', () => {
            // Spustit oba crawly souÄasnÄ›
            loadCrData();     // ÄŒR crawl
            loadRegionsData(); // KrajskÃ½ crawl
        });

        // Refresh dat se spouÅ¡tÃ­ automaticky po dokonÄenÃ­ kaÅ¾dÃ©ho crawlu (pÅ™es sentinel monitoring)
    </script>
</body>
</html>
