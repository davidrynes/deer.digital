<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawl kraje</title>
    <!-- 
        CORS ≈ôe≈°en√≠: 
        1. Pokus√≠ se o p≈ô√≠m√© naƒçten√≠ z API
        2. P≈ôi selh√°n√≠ pou≈æije CORS proxy (cors-anywhere.herokuapp.com)
        3. P≈ôi selh√°n√≠ obou pou≈æije fallback testovac√≠ data
        
        Pro aktivaci CORS proxy nav≈°tivte: https://cors-anywhere.herokuapp.com/corsdemo
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: transparent;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: flex-end;
        }

        .dashboard-container {
            width: 100%;
            height: 130px;
            background: transparent;
            display: flex;
            flex-direction: column;
            position: fixed;
            bottom: 0;
            left: 0;
        }

        .header {
            height: 35px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px;
        }

        .header-left {
            font-size: 16px;
            font-weight: 700;
            color: #212529;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }

        .header-right {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }

        /* Animace pro slide out */
        .header-left.slide-out {
            transform: translateX(-30px);
            opacity: 0;
        }

        .header-right.slide-out {
            transform: translateX(30px);
            opacity: 0;
        }

        /* Animace pro slide in */
        .header-left.slide-in {
            transform: translateX(30px);
            opacity: 0;
        }

        .header-right.slide-in {
            transform: translateX(-30px);
            opacity: 0;
        }

        .parties-container {
            display: flex;
            height: 95px;
            align-items: center;
            white-space: nowrap;
            /* Animace se nastavuje dynamicky podle obsahu */
            padding: 0 20px;
            transform: translateX(100%); /* Zaƒç√≠n√° vpravo */
        }

        .party-block {
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px 12px 8px 12px;
            margin: 0;
            min-width: 180px;
            position: relative;
            background: white;
            border-left: 4px solid;
            border-right: 2px solid #e9ecef;
            text-align: left;
            height: 95px;
            box-sizing: border-box;
        }

        .party-name {
            font-size: 18px;
            font-weight: 700;
            color: #212529;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }

        .party-stats-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin: 8px 0 4px 0;
        }

        .party-percent {
            font-size: 22px;
            font-weight: 800;
            color: #212529;
            line-height: 1;
        }

        .party-mandates {
            font-size: 11px;
            font-weight: 500;
            color: #6c757d;
            line-height: 1.1;
        }

        .party-votes {
            font-size: 11px;
            font-weight: 500;
            color: #6c757d;
            text-align: center;
            margin-top: auto;
            line-height: 1.1;
        }

        /* Divider mezi opakov√°n√≠mi */
        .divider {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 76px;
        }

        .divider-dot {
            width: 4px;
            height: 4px;
            background: #ced4da;
            border-radius: 50%;
            margin: 0 3px;
        }

        /* Loading state */
        .loading {
            color: #666;
            text-align: center;
            padding: 30px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Animace - bude se nastavovat dynamicky v JavaScript */
        @keyframes scroll-left-dynamic {
            0% {
                transform: translateX(100%); /* Zaƒç√≠n√° vpravo */
            }
            100% {
                /* Konec se nastavuje dynamicky aby posledn√≠ prvek √∫plnƒõ zmizel */
            }
        }

        /* Pulsing animace pro "ƒçek√°n√≠ na data" */
        @keyframes waiting-pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .party-percent {
            animation: waiting-pulse 2s infinite;
        }

        /* Responsivn√≠ √∫pravy */
        @media (max-width: 768px) {
            .dashboard-container {
                height: 110px;
            }
            
            .header {
                height: 30px;
                padding: 6px 15px;
            }
            
            .header-left {
                font-size: 14px;
            }
            
            .header-right {
                font-size: 12px;
            }
            
            .parties-container {
                height: 80px;
            }
            
            .party-block {
                min-width: 120px;
                height: 80px;
                padding: 6px 10px 6px 10px;
            }
            
            .party-name {
                font-size: 12px;
            }
            
            .party-percent {
                font-size: 20px;
            }
            
            .party-mandates, .party-votes {
                font-size: 10px;
            }
            
            .party-stats-row {
                margin: 4px 0 2px 0;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="header-left" id="headerLeft">V√Ωsledky voleb: Naƒç√≠t√°m kraje...</div>
            <div class="header-right" id="headerRight">seƒçteno: 0,00%, √∫ƒçast: 0,00%</div>
        </div>
        <div class="parties-container" id="partiesContainer">
            <div class="loading">P≈ôipojuji k API kraj≈Ø 2021...</div>
        </div>
    </div>

    <script>
        let regionsData = [];
        let currentRegionIndex = 0;
        let currentRegion = null;

        function formatNumber(num) {
            if (num === null || num === undefined) return "0";
            return num.toLocaleString('cs-CZ');
        }

        function formatPercent(num) {
            if (num === null || num === undefined) return "0.0";
            return num.toFixed(2);
        }

        function getMandatesText(num) {
            if (num === null || num === undefined || num === 0) return "mand√°t≈Ø";
            
            // ƒåesk√© sklo≈àov√°n√≠
            const lastDigit = num % 10;
            const lastTwoDigits = num % 100;
            
            // V√Ωjimky pro 11, 12, 13, 14
            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return "mand√°t≈Ø";
            }
            
            // Z√°kladn√≠ pravidla
            if (lastDigit === 1) {
                return "mand√°t";
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                return "mand√°ty";
            } else {
                return "mand√°t≈Ø";
            }
        }

        function updateHeader(region) {
            const headerLeft = document.getElementById('headerLeft');
            const headerRight = document.getElementById('headerRight');
            
            const turnout = region.turnout || {};
            const counted = turnout.precinctsFinishedPercent || 0;
            const voterTurnout = turnout.voterTurnout || 0;
            
            console.log(`[${new Date().toLocaleTimeString()}] üé≠ Spou≈°t√≠m header animaci pro: ${region.name}`);
            
            // F√°ze 1: Slide out (miz√≠ vlevo/vpravo)
            headerLeft.classList.add('slide-out');
            headerRight.classList.add('slide-out');
            
            setTimeout(() => {
                // F√°ze 2: Zmƒõna obsahu
                headerLeft.innerHTML = `V√Ωsledky voleb: ${region.name}`;
                headerRight.innerHTML = `seƒçteno: ${formatPercent(counted)}%, √∫ƒçast: ${formatPercent(voterTurnout)}%`;
                
                // F√°ze 3: P≈ô√≠prava slide in (zaƒç√≠n√° z opaƒçn√© strany)
                headerLeft.classList.remove('slide-out');
                headerRight.classList.remove('slide-out');
                headerLeft.classList.add('slide-in');
                headerRight.classList.add('slide-in');
                
                // F√°ze 4: Slide in (vj√≠≈æd√≠ do norm√°ln√≠ pozice)
                setTimeout(() => {
                    headerLeft.classList.remove('slide-in');
                    headerRight.classList.remove('slide-in');
                }, 50);
                
                }, 200); // Doba slide-out animace (zkr√°ceno z 300ms)
        }

        async function loadRegionsData() {
            try {
                console.log(`[${new Date().toLocaleTimeString()}] Naƒç√≠t√°m data kraj≈Ø z API...`);
                
                let response;
                let data;
                
                try {
                    // Pokus o p≈ô√≠m√© naƒçten√≠
                    response = await fetch('https://api.elections.seznam.cz/parliament/2021/regions');
                    if (!response.ok) throw new Error('Direct fetch failed');
                    data = await response.json();
                    console.log(`[${new Date().toLocaleTimeString()}] ‚úÖ P≈ô√≠m√© naƒçten√≠ √∫spƒõ≈°n√©`);
                } catch (error) {
                    // Fallback na CORS proxy
                    console.log(`[${new Date().toLocaleTimeString()}] ‚ö†Ô∏è P≈ô√≠m√© naƒçten√≠ selhalo, pou≈æ√≠v√°m CORS proxy...`);
                    const proxyUrl = 'https://cors-anywhere.herokuapp.com/https://api.elections.seznam.cz/parliament/2021/regions';
                    response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Proxy fetch failed');
                    data = await response.json();
                    console.log(`[${new Date().toLocaleTimeString()}] ‚úÖ CORS proxy √∫spƒõ≈°n√©`);
                }
                
                console.log(`[${new Date().toLocaleTimeString()}] Data √∫spƒõ≈°nƒõ naƒçtena:`, data._items.length, 'kraj≈Ø');
                
                regionsData = data._items.map(region => ({
                    number: region.number,
                    name: region.name,
                    turnout: region.turnout,
                    parties: region.parties
                        .filter(party => party.shortName8 && party.shortName8.length > 1)
                        .map(party => ({
                            shortName8: party.shortName8,
                            color: party.vParty.color || '#6c757d',
                            votes: party.results.votes,
                            votesPercent: party.results.votesPercent,
                            numOfMandates: party.numOfMandates || 0
                        }))
                        .sort((a, b) => b.votesPercent - a.votesPercent) // Se≈ôadit podle procent
                }));
                
                console.log(`[${new Date().toLocaleTimeString()}] Zpracov√°no kraj≈Ø:`, regionsData.length);
                
                // Zaƒç√≠t s prvn√≠m krajem
                currentRegionIndex = 0;
                startRegionCycling();
                
            } catch (error) {
                console.error('üö® Obƒõ metody naƒç√≠t√°n√≠ selhaly:', error);
                console.log('üìå Tip: Pro lok√°ln√≠ testov√°n√≠ otev≈ôete https://cors-anywhere.herokuapp.com/corsdemo a povolte po≈æadavky');
                
                // Fallback na testovac√≠ data
                regionsData = [
                    {
                        number: 1,
                        name: "Hlavn√≠ mƒõsto Praha",
                        turnout: { voterTurnout: 65.0, precinctsFinishedPercent: 100.0 },
                        parties: [
                            { shortName8: "SPOLU", color: "#4175e0", votes: 150000, votesPercent: 35.0, numOfMandates: 8 },
                            { shortName8: "ANO", color: "#33cccc", votes: 120000, votesPercent: 28.0, numOfMandates: 6 },
                            { shortName8: "≈†v√Ωcar. demokr.", color: "#222222", votes: 80000, votesPercent: 18.5, numOfMandates: 4 }
                        ]
                    }
                ];
                
                console.log(`[${new Date().toLocaleTimeString()}] üîÑ Pou≈æ√≠v√°m fallback testovac√≠ data`);
                startRegionCycling();
            }
        }

        function startRegionCycling() {
            if (regionsData.length === 0) return;
            
            displayCurrentRegion(false); // Prvn√≠ naƒçten√≠ s animac√≠ headeru
            
            // P≈ôidat event listener pro p≈ôesnƒõj≈°√≠ timing
            const partiesContainer = document.getElementById('partiesContainer');
            partiesContainer.addEventListener('animationend', (event) => {
                // Ovƒõ≈ôit, ≈æe event poch√°z√≠ z crawl animace (ne z jin√© animace)
                if (event.target !== partiesContainer) return;
                
                console.log(`[${new Date().toLocaleTimeString()}] üèÅ Crawl dokonƒçen pro kraj: ${currentRegion.name}`);
                
                // Okam≈æitƒõ zmƒõnit na dal≈°√≠ kraj
                currentRegionIndex = (currentRegionIndex + 1) % regionsData.length;
                const nextRegion = regionsData[currentRegionIndex];
                
                console.log(`[${new Date().toLocaleTimeString()}] üîÑ Okam≈æitƒõ p≈ôep√≠n√°m na: ${nextRegion.name}`);
                
                // Spustit animaci headeru
                updateHeader(nextRegion);
                
                // Naƒç√≠st nov√Ω crawl rychleji
                setTimeout(() => {
                    console.log(`[${new Date().toLocaleTimeString()}] ‚ö° Spou≈°t√≠m crawl pro: ${nextRegion.name}`);
                    displayCurrentRegion(true); // Header u≈æ byl animov√°n
                }, 300); // 200ms slide-out + 200ms slide-in + 100ms buffer = 500ms, ale zkr√°t√≠me na 300ms
            });
        }

        function displayCurrentRegion(isHeaderAlreadyAnimated = false) {
            currentRegion = regionsData[currentRegionIndex];
            
            const logPrefix = isHeaderAlreadyAnimated ? "‚è© Naƒç√≠t√°m crawl pro:" : "üèÅ Zobrazuji prvn√≠ kraj:";
            console.log(`[${new Date().toLocaleTimeString()}] ${logPrefix}`, currentRegion.name);
            
            // Aktualizovat header (animace jen pokud je≈°tƒõ nebyla provedena)
            if (!isHeaderAlreadyAnimated) {
                updateHeader(currentRegion);
            }
            
            // Generovat crawl obsah
            generateCrawlContent();
        }

        function generateCrawlContent() {
            const partiesContainer = document.getElementById('partiesContainer');
            
            if (!currentRegion || !currentRegion.parties) {
                partiesContainer.innerHTML = '<div class="loading">≈Ω√°dn√° data pro aktu√°ln√≠ kraj</div>';
                return;
            }
            
            // Smooth update - p≈ôidat updating class
            partiesContainer.classList.add('updating');
            
            setTimeout(() => {
                let content = '';
                
                // Vytvo≈ôit obsah pouze jednou (ne opakov√°n√≠)
                currentRegion.parties.forEach((party, index) => {
                    const displayName = party.shortName8.length > 15 ? party.shortName8.substring(0, 10) : party.shortName8;
                    
                    const percent = formatPercent(party.votesPercent);
                    const mandates = party.numOfMandates || 0;
                    const votes = formatNumber(party.votes);
                    const mandatesText = getMandatesText(mandates);
                    
                    content += `
                        <div class="party-block" style="border-left-color: ${party.color};">
                            <div class="party-name">${displayName}</div>
                            <div class="party-stats-row">
                                <div class="party-percent">${percent}%</div>
                                <div class="party-mandates">${mandates} ${mandatesText}</div>
                            </div>
                            <div class="party-votes">${votes} hlas≈Ø</div>
                        </div>
                    `;
                });
                
                partiesContainer.innerHTML = content;
                partiesContainer.classList.remove('updating');
                
                // Spustit animaci po naƒçten√≠ obsahu
                startCrawlAnimation();
                
            }, 150);
        }

        function startCrawlAnimation() {
            const partiesContainer = document.getElementById('partiesContainer');
            
            // Vypoƒç√≠tat ≈°√≠≈ôky
            const viewportWidth = window.innerWidth;
            const contentWidth = partiesContainer.scrollWidth;
            
            // Vypoƒç√≠tat spr√°vn√Ω koneƒçn√Ω translateX tak, aby posledn√≠ prvek √∫plnƒõ zmizel vlevo
            // Od -100% je≈°tƒõ odeƒçteme pomƒõr ≈°√≠≈ôky obsahu k viewportu
            const finalTranslatePercent = -100 - (contentWidth / viewportWidth * 100);
            
            // Vypoƒç√≠tat dobu animace (rychlost: 100px za sekundu)
            // Celkov√° vzd√°lenost je od 100% doprava do finalTranslatePercent vlevo
            const totalDistance = viewportWidth + contentWidth; // v pixelech
            const animationDuration = totalDistance / 100; // sekundy
            
            console.log(`[${new Date().toLocaleTimeString()}] üé¨ Crawl: ${contentWidth}px obsah, konec na ${finalTranslatePercent.toFixed(0)}%, doba ${animationDuration.toFixed(1)}s`);
            
            // Vytvo≈ôit dynamick√© CSS keyframe
            const keyframeName = 'scroll-left-' + Date.now();
            const keyframeCSS = `
                @keyframes ${keyframeName} {
                    0% { transform: translateX(100%); }
                    100% { transform: translateX(${finalTranslatePercent}%); }
                }
            `;
            
            // P≈ôidat keyframe do stylu
            const styleElement = document.createElement('style');
            styleElement.textContent = keyframeCSS;
            document.head.appendChild(styleElement);
            
            // Resetovat pozici na zaƒç√°tek (vpravo)
            partiesContainer.style.transform = 'translateX(100%)';
            partiesContainer.style.animation = 'none';
            
            // Spustit animaci
            setTimeout(() => {
                partiesContainer.style.animation = `${keyframeName} ${animationDuration}s linear`;
                
                // Vyƒçistit keyframe po animaci
                setTimeout(() => {
                    try {
                        if (styleElement.parentNode) {
                            document.head.removeChild(styleElement);
                        }
                    } catch (error) {
                        console.log('Keyframe cleanup skipped:', error.message);
                    }
                }, animationDuration * 1000 + 1000);
            }, 50);
        }

        // Spustit naƒç√≠t√°n√≠ dat po naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', loadRegionsData);
        
        // Aktualizovat data ka≈æd√Ωch 5 minut (pro p≈ô√≠padn√© zmƒõny)
        setInterval(loadRegionsData, 5 * 60 * 1000);
    </script>
</body>
</html>
